// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgres"
  url       = env("DATABASE_URL")
  // Pour utiliser Prisma Migrate
  directUrl = env("DIRECT_DATABASE_URL")
}

// Modèle pour les clients multi-tenant
model Client {
  id                   String                @id @default(cuid())
  name                 String                @unique
  domain               String?               @unique // ex: clientA.domain.com pour isolation par domaine
  apiKeys              Json // clés API externes (chiffrées en production)
  settings             Json? // paramètres personnalisés (devise, timezone, etc.)
  modules              ModuleOnClient[]
  environmentVariables EnvironmentVariable[]
  users                User[]
  libraries            Library[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@map("clients")
}

// Modèle pour les modules disponibles
model Module {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  version     String?
  clients     ModuleOnClient[]

  @@map("modules")
}

// Relation many-to-many entre clients et modules
model ModuleOnClient {
  id       String  @id @default(cuid())
  clientId String
  moduleId String
  enabled  Boolean @default(true)
  client   Client  @relation(fields: [clientId], references: [id])
  module   Module  @relation(fields: [moduleId], references: [id])

  @@unique([clientId, moduleId])
  @@map("module_on_clients")
}

// Modèle pour les variables d'environnement par client et environnement
model EnvironmentVariable {
  id          String      @id @default(cuid())
  key         String // ex: API_KEY, DATABASE_URL
  value       String // valeur chiffrée en production
  environment Environment @default(DEVELOPMENT) // dev, staging, production
  clientId    String
  client      Client      @relation(fields: [clientId], references: [id])

  @@unique([key, environment, clientId])
  @@map("environment_variables")
}

// Enums pour les environnements
enum Environment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  avatar         String?
  hashedPassword String? // Null si OAuth uniquement
  oauthProvider  String? // "github", "google", etc.
  oauthId        String? // ID externe du provider
  role           Role     @default(BUYER)
  clientId       String
  client         Client   @relation(fields: [clientId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  apiKeys           ApiKey[]
  mcpConfigurations MCPConfiguration[]
  usageLogs         UsageLog[]
  oauthTokens       OAuthToken[]

  @@map("users")
}

// Tables TwinMCP Core

model Library {
  id              String    @id // ex: /mongodb/docs
  name            String    @unique
  displayName     String
  description     String?
  vendor          String?
  repoUrl         String?   @map("repo_url")
  docsUrl         String?   @map("docs_url")
  defaultVersion  String?   @map("default_version")
  popularityScore Float     @default(0) @map("popularity_score")
  totalSnippets   Int       @default(0) @map("total_snippets")
  totalTokens     Int       @default(0) @map("total_tokens")
  language        String
  ecosystem       String
  tags            String[]
  metadata        Json?
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id])
  lastCrawledAt   DateTime? @map("last_crawled_at")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  versions            LibraryVersion[]
  aliases             LibraryAlias[]
  documentationChunks DocumentationChunk[]
  usageLogs           UsageLog[]

  @@map("libraries")
}

model LibraryVersion {
  id              String    @id @default(cuid())
  libraryId       String    @map("library_id")
  library         Library   @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  version         String
  releaseDate     DateTime? @map("release_date")
  isLatest        Boolean   @default(false) @map("is_latest")
  docsSnapshotUrl String?   @map("docs_snapshot_url")

  documentationChunks DocumentationChunk[]

  @@unique([libraryId, version])
  @@map("library_versions")
}

model LibraryAlias {
  id        String  @id @default(cuid())
  libraryId String  @map("library_id")
  library   Library @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  alias     String

  @@unique([libraryId, alias])
  @@map("library_aliases")
}

model DocumentationChunk {
  id               String         @id @default(cuid())
  libraryVersionId String         @map("library_version_id")
  libraryVersion   LibraryVersion @relation(fields: [libraryVersionId], references: [id], onDelete: Cascade)
  chunkIndex       Int            @map("chunk_index")
  content          String
  contentType      String         @map("content_type") // 'snippet', 'guide', 'api_ref'
  sourceUrl        String?        @map("source_url")
  tokenCount       Int            @map("token_count")
  embeddingId      String?        @map("embedding_id")
  metadata         Json?
  createdAt        DateTime       @default(now())
  Library          Library?       @relation(fields: [libraryId], references: [id])
  libraryId        String?

  @@map("documentation_chunks")
}

model ApiKey {
  id                     String    @id @default(cuid())
  userId                 String    @map("user_id")
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash                String    @unique @map("key_hash")
  keyPrefix              String    @map("key_prefix")
  name                   String?
  tier                   String    @default("free") // 'free' | 'basic' | 'premium' | 'enterprise'
  quotaDaily             Int       @default(100) @map("quota_daily")
  quotaMonthly           Int       @default(3000) @map("quota_monthly")
  usedDaily              Int       @default(0) @map("used_daily")
  usedMonthly            Int       @default(0) @map("used_monthly")
  lastUsedAt             DateTime? @map("last_used_at")
  expiresAt              DateTime? @map("expires_at")
  isActive               Boolean   @default(true) @map("is_active")
  permissions            Json      @default("[]")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  revokedAt              DateTime? @map("revoked_at")

  usageLogs UsageLog[]

  @@map("api_keys")
}

model UsageLog {
  id             String   @id @default(cuid())
  userId         String?  @map("user_id")
  user           User?    @relation(fields: [userId], references: [id])
  apiKeyId       String?  @map("api_key_id")
  apiKey         ApiKey?  @relation(fields: [apiKeyId], references: [id])
  libraryId      String?  @map("library_id")
  library        Library? @relation(fields: [libraryId], references: [id])
  toolName       String   @map("tool_name") // 'resolve-library-id', 'query-docs'
  query          String?
  tokensReturned Int?     @map("tokens_returned")
  responseTimeMs Int?     @map("response_time_ms")
  createdAt      DateTime @default(now())

  @@map("usage_logs")
}

// Nouveau modèle pour les configurations MCP
model MCPConfiguration {
  id          String       @id @default(cuid())
  name        String
  description String?
  configData  Json // Stocke les paramètres de configuration au format JSON
  status      ConfigStatus @default(ACTIVE)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("mcp_configurations")
}

// Enums
enum Role {
  BUYER
  SELLER
  ADMIN
}

enum Status {
  ACTIVE
  INACTIVE
  DRAFT
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ConfigStatus {
  ACTIVE
  INACTIVE
  TESTING
  ERROR
}

// Tokens OAuth existants (pour authentification externe)
model OAuthToken {
  id           String   @id @default(cuid())
  userId       String
  provider     String // "github", "google", etc.
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("oauth_tokens")
}

// Tables OAuth 2.0 pour autorisation

model OAuthClient {
  id                String   @id @default(cuid())
  clientId          String   @unique @map("client_id")
  clientSecretHash  String   @map("client_secret_hash")
  name              String
  redirectUris      String[] @map("redirect_uris")
  allowedScopes     String[] @map("allowed_scopes")
  grantTypes        String[] @map("grant_types")
  requirePkce       Boolean  @default(true) @map("require_pkce")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  authorizationCodes OAuthAuthorizationCode[]
  accessTokens      OAuthAccessToken[]
  refreshTokens     OAuthRefreshToken[]

  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id                   String    @id @default(cuid())
  code                 String    @unique
  clientId             String    @map("client_id")
  userId               String    @map("user_id")
  redirectUri          String    @map("redirect_uri")
  scopes               String[]
  codeChallenge        String?   @map("code_challenge")
  codeChallengeMethod  String?   @map("code_challenge_method")
  expiresAt            DateTime  @map("expires_at")
  createdAt            DateTime  @default(now()) @map("created_at")

  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("oauth_authorization_codes")
}

model OAuthAccessToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique @map("token_hash")
  clientId  String   @map("client_id")
  userId    String   @map("user_id")
  scopes    String[]
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  client        OAuthClient         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  refreshToken  OAuthRefreshToken[]

  @@map("oauth_access_tokens")
}

model OAuthRefreshToken {
  id           String   @id @default(cuid())
  tokenHash    String   @unique @map("token_hash")
  accessTokenId String   @map("access_token_id")
  clientId     String   @map("client_id")
  userId       String   @map("user_id")
  scopes       String[]
  expiresAt    DateTime @map("expires_at")
  isRevoked    Boolean  @default(false) @map("is_revoked")
  createdAt    DateTime @default(now()) @map("created_at")

  accessToken OAuthAccessToken @relation(fields: [accessTokenId], references: [id], onDelete: Cascade)
  client      OAuthClient      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("oauth_refresh_tokens")
}
