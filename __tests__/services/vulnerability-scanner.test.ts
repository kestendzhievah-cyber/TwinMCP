import { VulnerabilityScannerService } from '../../src/services/library/vulnerability-scanner.service'

describe('VulnerabilityScannerService', () => {
  let scanner: VulnerabilityScannerService

  beforeEach(() => {
    scanner = new VulnerabilityScannerService()
    scanner.loadAdvisories([
      {
        id: 'CVE-2023-001', title: 'XSS in foo', description: 'Cross-site scripting',
        severity: 'high', cvssScore: 7.5, affectedPackage: 'foo',
        affectedVersions: '>=1.0.0 <1.5.3', patchedVersions: '>=1.5.3',
        cwe: 'CWE-79', publishedAt: '2023-06-01',
      },
      {
        id: 'CVE-2023-002', title: 'RCE in bar', description: 'Remote code execution',
        severity: 'critical', cvssScore: 9.8, affectedPackage: 'bar',
        affectedVersions: '>=2.0.0 <2.3.0', patchedVersions: '>=2.3.0',
        publishedAt: '2023-07-15',
      },
      {
        id: 'CVE-2023-003', title: 'Info leak in foo', description: 'Information disclosure',
        severity: 'medium', cvssScore: 5.3, affectedPackage: 'foo',
        affectedVersions: '>=1.0.0 <1.2.0',
        publishedAt: '2023-05-01',
      },
    ])
  })

  describe('Advisory management', () => {
    it('loads advisories', () => {
      expect(scanner.advisoryCount).toBe(3)
    })

    it('retrieves advisories by package name', () => {
      expect(scanner.getAdvisories('foo').length).toBe(2)
      expect(scanner.getAdvisories('bar').length).toBe(1)
      expect(scanner.getAdvisories('unknown').length).toBe(0)
    })

    it('is case-insensitive', () => {
      expect(scanner.getAdvisories('FOO').length).toBe(2)
    })
  })

  describe('Version matching', () => {
    it('matches version in range >=1.0.0 <1.5.3', () => {
      expect(scanner.isVersionAffected('1.3.0', '>=1.0.0 <1.5.3')).toBe(true)
      expect(scanner.isVersionAffected('1.0.0', '>=1.0.0 <1.5.3')).toBe(true)
      expect(scanner.isVersionAffected('1.5.3', '>=1.0.0 <1.5.3')).toBe(false)
      expect(scanner.isVersionAffected('0.9.0', '>=1.0.0 <1.5.3')).toBe(false)
    })

    it('matches exact version', () => {
      expect(scanner.isVersionAffected('1.0.0', '1.0.0')).toBe(true)
      expect(scanner.isVersionAffected('1.0.1', '1.0.0')).toBe(false)
    })

    it('matches >= only', () => {
      expect(scanner.isVersionAffected('2.0.0', '>=1.5.0')).toBe(true)
      expect(scanner.isVersionAffected('1.4.0', '>=1.5.0')).toBe(false)
    })

    it('matches < only', () => {
      expect(scanner.isVersionAffected('1.0.0', '<2.0.0')).toBe(true)
      expect(scanner.isVersionAffected('2.0.0', '<2.0.0')).toBe(false)
    })
  })

  describe('Package scanning', () => {
    it('finds vulnerabilities for affected package', () => {
      const result = scanner.scanPackage({ name: 'foo', version: '1.3.0' })
      expect(result.totalVulnerabilities).toBe(1) // CVE-2023-001 matches, CVE-2023-003 doesn't (1.3.0 >= 1.2.0)
      expect(result.riskLevel).toBe('high')
    })

    it('finds multiple vulnerabilities', () => {
      const result = scanner.scanPackage({ name: 'foo', version: '1.1.0' })
      expect(result.totalVulnerabilities).toBe(2) // Both CVE-2023-001 and CVE-2023-003
    })

    it('returns no vulnerabilities for safe version', () => {
      const result = scanner.scanPackage({ name: 'foo', version: '2.0.0' })
      expect(result.totalVulnerabilities).toBe(0)
      expect(result.riskLevel).toBe('info')
    })

    it('returns no vulnerabilities for unknown package', () => {
      const result = scanner.scanPackage({ name: 'unknown-pkg', version: '1.0.0' })
      expect(result.totalVulnerabilities).toBe(0)
    })
  })

  describe('Full scan report', () => {
    it('generates a scan report for multiple packages', () => {
      const report = scanner.scan([
        { name: 'foo', version: '1.1.0' },
        { name: 'bar', version: '2.1.0' },
        { name: 'safe-pkg', version: '1.0.0' },
      ])

      expect(report.id).toBeDefined()
      expect(report.summary.totalPackages).toBe(3)
      expect(report.summary.vulnerablePackages).toBe(2)
      expect(report.summary.totalVulnerabilities).toBe(3) // 2 for foo + 1 for bar
      expect(report.summary.overallRisk).toBe('critical') // bar has critical
      expect(report.summary.bySeverity.critical).toBe(1)
      expect(report.summary.bySeverity.high).toBe(1)
      expect(report.summary.bySeverity.medium).toBe(1)
    })

    it('reports all safe when no vulnerabilities', () => {
      const report = scanner.scan([
        { name: 'foo', version: '2.0.0' },
        { name: 'bar', version: '3.0.0' },
      ])

      expect(report.summary.vulnerablePackages).toBe(0)
      expect(report.summary.overallRisk).toBe('info')
    })
  })
})
