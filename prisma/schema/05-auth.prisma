// ─── Auth, API Keys & OAuth Models ───────────────────────────────

model ApiKey {
  id                     String    @id @default(cuid())
  userId                 String    @map("user_id")
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash                String    @unique @map("key_hash")
  keyPrefix              String    @map("key_prefix")
  name                   String?
  tier                   String    @default("free")
  quotaDaily             Int       @default(100) @map("quota_daily")
  quotaMonthly           Int       @default(3000) @map("quota_monthly")
  usedDaily              Int       @default(0) @map("used_daily")
  usedMonthly            Int       @default(0) @map("used_monthly")
  lastUsedAt             DateTime? @map("last_used_at")
  expiresAt              DateTime? @map("expires_at")
  isActive               Boolean   @default(true) @map("is_active")
  permissions            Json      @default("[]")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  revokedAt              DateTime? @map("revoked_at")

  usageLogs UsageLog[]

  @@map("api_keys")
}

model UsageLog {
  id             String   @id @default(cuid())
  userId         String?  @map("user_id")
  user           User?    @relation(fields: [userId], references: [id])
  apiKeyId       String?  @map("api_key_id")
  apiKey         ApiKey?  @relation(fields: [apiKeyId], references: [id])
  libraryId      String?  @map("library_id")
  library        Library? @relation(fields: [libraryId], references: [id])
  toolName       String   @map("tool_name")
  query          String?
  tokensReturned Int?     @map("tokens_returned")
  responseTimeMs Int?     @map("response_time_ms")
  success        Boolean  @default(true)
  errorMessage   String?  @map("error_message")
  createdAt      DateTime @default(now())

  @@index([apiKeyId, createdAt])
  @@index([userId, createdAt])
  @@map("usage_logs")
}

model OAuthToken {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("oauth_tokens")
}

model OAuthClient {
  id                String   @id @default(cuid())
  clientId          String   @unique @map("client_id")
  clientSecretHash  String   @map("client_secret_hash")
  name              String
  redirectUris      String[] @map("redirect_uris")
  allowedScopes     String[] @map("allowed_scopes")
  grantTypes        String[] @map("grant_types")
  requirePkce       Boolean  @default(true) @map("require_pkce")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  authorizationCodes OAuthAuthorizationCode[]
  accessTokens      OAuthAccessToken[]
  refreshTokens     OAuthRefreshToken[]

  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id                   String    @id @default(cuid())
  code                 String    @unique
  clientId             String    @map("client_id")
  userId               String    @map("user_id")
  redirectUri          String    @map("redirect_uri")
  scopes               String[]
  codeChallenge        String?   @map("code_challenge")
  codeChallengeMethod  String?   @map("code_challenge_method")
  expiresAt            DateTime  @map("expires_at")
  createdAt            DateTime  @default(now()) @map("created_at")

  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("oauth_authorization_codes")
}

model OAuthAccessToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique @map("token_hash")
  clientId  String   @map("client_id")
  userId    String   @map("user_id")
  scopes    String[]
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  client        OAuthClient         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  refreshToken  OAuthRefreshToken[]

  @@map("oauth_access_tokens")
}

model OAuthRefreshToken {
  id           String   @id @default(cuid())
  tokenHash    String   @unique @map("token_hash")
  accessTokenId String   @map("access_token_id")
  clientId     String   @map("client_id")
  userId       String   @map("user_id")
  scopes       String[]
  expiresAt    DateTime @map("expires_at")
  isRevoked    Boolean  @default(false) @map("is_revoked")
  createdAt    DateTime @default(now()) @map("created_at")

  accessToken OAuthAccessToken @relation(fields: [accessTokenId], references: [id], onDelete: Cascade)
  client      OAuthClient      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("oauth_refresh_tokens")
}
