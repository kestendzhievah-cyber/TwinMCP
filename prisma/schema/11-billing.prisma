// ─── Billing & Subscription Models ───────────────────────────────

model Invoice {
  id          String      @id @default(cuid())
  number      String      @unique
  userId      String      @map("user_id")
  userProfile UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      InvoiceStatus @default(DRAFT)
  period      Json
  issueDate   DateTime    @default(now()) @map("issue_date")
  dueDate     DateTime    @map("due_date")
  paidDate    DateTime?   @map("paid_date")
  subtotal     Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @default(0) @db.Decimal(10, 2)
  currency    String      @default("EUR")
  items       Json        @default("[]")
  billingAddress Json      @default("{}") @map("billing_address")
  metadata    Json        @default("{}")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  payments    Payment[]
  
  @@map("invoices")
}

model Payment {
  id                    String        @id @default(cuid())
  invoiceId             String        @map("invoice_id")
  invoice               Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  userId                String        @map("user_id")
  userProfile           UserProfile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount                Decimal       @db.Decimal(10, 2)
  currency              String
  status                PaymentStatus  @default(PENDING)
  providerTransactionId  String?       @map("provider_transaction_id")
  failureReason         String?       @map("failure_reason")
  refundedAmount        Decimal?      @map("refunded_amount") @db.Decimal(10, 2)
  createdAt             DateTime      @default(now()) @map("created_at")
  processedAt           DateTime?     @map("processed_at")
  metadata              Json          @default("{}")
  
  @@map("payments")
}

model Subscription {
  id                String            @id @default(cuid())
  userId            String            @map("user_id")
  userProfile       UserProfile       @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              String
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime          @map("current_period_start")
  currentPeriodEnd   DateTime          @map("current_period_end")
  cancelAtPeriodEnd  Boolean           @default(false) @map("cancel_at_period_end")
  amount            Decimal            @db.Decimal(10, 2)
  currency          String
  interval          SubscriptionInterval @default(MONTH)
  intervalCount     Int               @default(1) @map("interval_count")
  trialStart        DateTime?          @map("trial_start")
  trialEnd          DateTime?          @map("trial_end")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  metadata          Json               @default("{}")
  
  @@map("subscriptions")
}

model Credit {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  userProfile UserProfile      @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Decimal          @db.Decimal(10, 2)
  currency  String
  reason    String
  type      CreditType
  expiresAt DateTime?        @map("expires_at")
  usedAt    DateTime?         @map("used_at")
  invoiceId String?          @map("invoice_id")
  createdAt DateTime          @default(now()) @map("created_at")
  metadata  Json              @default("{}")
  
  @@map("credits")
}

model BillingAlert {
  id           String           @id @default(cuid())
  userId       String           @map("user_id")
  type         BillingAlertType
  threshold    Decimal?         @db.Decimal(10, 2)
  currentValue Decimal?         @db.Decimal(10, 2) @map("current_value")
  message      String
  isRead       Boolean          @default(false) @map("is_read")
  createdAt    DateTime         @default(now()) @map("created_at")
  readAt       DateTime?        @map("read_at")
  metadata     Json             @default("{}")
  
  @@map("billing_alerts")
}

model Plan {
  id          String   @id @default(cuid())
  name        String
  description String?
  amount      Decimal  @db.Decimal(10, 2)
  currency    String
  interval    PlanInterval @default(MONTH)
  features    String[]
  limits      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  metadata    Json     @default("{}")
  
  @@map("plans")
}

// ─── Billing Enums ────────────────────────────────────────────────

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum SubscriptionInterval {
  MONTH
  YEAR
}

enum CreditType {
  PROMOTIONAL
  REFUND
  COMPENSATION
  ADJUSTMENT
}

enum BillingAlertType {
  USAGE_THRESHOLD
  PAYMENT_FAILED
  INVOICE_OVERDUE
  SUBSCRIPTION_EXPIRING
}

enum PlanInterval {
  MONTH
  YEAR
}
